{% assign post = closest.metaobject['nn_instagram_post'] %}
{% assign instagram_list = metaobjects['nn_instagram_list']['instagram-feed-list'] %}

{% liquid
  assign onboarding = false
  assign instagram_username = 'instagram'

  if post == blank
    assign onboarding = true
  endif

  # Get username from the nn_instagram_list metaobject
  if instagram_list.username != blank
    assign instagram_username = instagram_list.username
  endif

  # Get overlay settings from this block
  assign show_overlay = block.settings.overlay_content
  assign overlay_opacity = block.settings.overlay_opacity | divided_by: 100.0
  assign overlay_info = block.settings.overlay_info
  assign caption_max_lines = block.settings.caption_max_lines
%}

<div
  class="instagram-post-image instagram-post-image--{{ block.settings.image_ratio | replace: '/', '-' }} {% if show_overlay %}instagram-post-image--has-overlay{% endif %}"
  data-block-id="{{ block.id }}"
  style="
    border-radius: {{ block.settings.border_radius }}px;
    overflow: hidden;
    --overlay-opacity: {{ overlay_opacity }};
  "
  {{ block.shopify_attributes }}
>
  {% if onboarding %}
    {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
  {% else %}
    {% comment %} Get first image/video from images array {% endcomment %}
    {% for media in post.images.value limit: 1 %}
      {% if media.sources %}
        {{ media | video_tag: autoplay: true, loop: true, muted: true, class: 'instagram-post-image__video' }}
      {% else %}
        <img
          class="instagram-post-image__img"
          src="{{ media | image_url: width: 800, height: 1200, crop: 'center' }}"
          alt="{{ post.caption.value | escape | truncate: 100 }}"
          loading="lazy"
          width="800"
          height="1200"
        >
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if show_overlay %}
    <!-- Overlay link (shown on hover) -->
    <a
      href="https://instagram.com/{{ instagram_username }}"
      target="_blank"
      rel="noopener noreferrer"
      class="instagram-post-image__overlay-link"
      aria-label="View on Instagram"
    >
      <div class="instagram-post-image__overlay-content">
        <svg width="48px" height="48px" fill="#ffffffff" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <g id="SVGRepo_bgCarrier" stroke-width="2"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><title></title><path d="M44,57H20A13,13,0,0,1,7,44V20A13,13,0,0,1,20,7H44A13,13,0,0,1,57,20V44A13,13,0,0,1,44,57ZM20,9A11,11,0,0,0,9,20V44A11,11,0,0,0,20,55H44A11,11,0,0,0,55,44V20A11,11,0,0,0,44,9Z"></path><path d="M32,43.67A11.67,11.67,0,1,1,43.67,32,11.68,11.68,0,0,1,32,43.67Zm0-21.33A9.67,9.67,0,1,0,41.67,32,9.68,9.68,0,0,0,32,22.33Z"></path><path d="M44.5,21A3.5,3.5,0,1,1,48,17.5,3.5,3.5,0,0,1,44.5,21Zm0-5A1.5,1.5,0,1,0,46,17.5,1.5,1.5,0,0,0,44.5,16Z"></path></g>
        </svg>
        
        {% if overlay_info == 'caption' and post.caption.value != blank %}
          <p class="instagram-post-image__overlay-caption" style="-webkit-line-clamp: {{ caption_max_lines }}; line-clamp: {{ caption_max_lines }};">
            {{ post.caption.value }}
          </p>
        {% elsif overlay_info == 'likes' %}
          <div class="instagram-post-image__overlay-meta">
            {% if post.likes.value != blank %}
              <span class="instagram-post-image__overlay-likes">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white" aria-hidden="true">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                {{ post.likes.value }}
              </span>
            {% endif %}
            
            {% if post.comments.value != blank %}
              <span class="instagram-post-image__overlay-comments">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white" aria-hidden="true">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                </svg>
                {{ post.comments.value }}
              </span>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </a>
  {% endif %}
</div>

{% stylesheet %}
  .instagram-post-image {
    position: relative;
    width: 100%;
    overflow: hidden;
    background: var(--color-background, #000);
    --overlay-opacity: 0.5;
  }

  /* Overlay background - only show on images with overlay enabled */
  .instagram-post-image--has-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, var(--overlay-opacity));
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 1;
  }

  .instagram-post-image--has-overlay:hover::after {
    opacity: 1;
  }

  /* Overlay link - make whole overlay clickable */
  .instagram-post-image__overlay-link {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    text-decoration: none;
  }

  .instagram-post-image--has-overlay:hover .instagram-post-image__overlay-link {
    opacity: 1;
    pointer-events: auto;
  }

  .instagram-post-image__overlay-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 1.5rem;
    max-width: 90%;
    text-align: center;
  }

  .instagram-post-image__overlay-content svg {
    flex-shrink: 0;
  }

  .instagram-post-image__overlay-caption {
    color: white;
    font-size: 0.875rem;
    line-height: 1.4;
    margin: 0;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
  }

  .instagram-post-image__overlay-meta {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    font-weight: 600;
  }

  .instagram-post-image__overlay-likes,
  .instagram-post-image__overlay-comments {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .instagram-post-image__overlay-meta svg {
    flex-shrink: 0;
  }

  .instagram-post-image__overlay-link:hover .instagram-post-image__overlay-content svg {
    transform: scale(1.1);
  }

  .instagram-post-image--1-1,
  .instagram-post-image--4-5,
  .instagram-post-image--3-4,
  .instagram-post-image--2-3 {
    position: relative;
    width: 100%;
  }

  .instagram-post-image--1-1::before {
    content: '';
    display: block;
    padding-top: 100%; /* 1:1 */
  }

  .instagram-post-image--4-5::before {
    content: '';
    display: block;
    padding-top: 125%; /* 4:5 */
  }

  .instagram-post-image--3-4::before {
    content: '';
    display: block;
    padding-top: 133.33%; /* 3:4 */
  }

  .instagram-post-image--2-3::before {
    content: '';
    display: block;
    padding-top: 150%; /* 2:3 */
  }

  .instagram-post-image--1-1 .instagram-post-image__img,
  .instagram-post-image--1-1 .instagram-post-image__video,
  .instagram-post-image--4-5 .instagram-post-image__img,
  .instagram-post-image--4-5 .instagram-post-image__video,
  .instagram-post-image--3-4 .instagram-post-image__img,
  .instagram-post-image--3-4 .instagram-post-image__video,
  .instagram-post-image--2-3 .instagram-post-image__img,
  .instagram-post-image--2-3 .instagram-post-image__video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .instagram-post-image__img,
  .instagram-post-image__video {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  .instagram-post-image .placeholder-svg {
    width: 100%;
    height: auto;
    display: block;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Instagram Post Image",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "Displays image or video from parent Instagram post"
    },
    {
      "type": "header",
      "content": "Image Settings"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image aspect ratio",
      "options": [
        {
          "value": "adapt",
          "label": "Adapt to image"
        },
        {
          "value": "1/1",
          "label": "Square (1:1)"
        },
        {
          "value": "4/5",
          "label": "Portrait (4:5)"
        },
        {
          "value": "3/4",
          "label": "3:4"
        },
        {
          "value": "2/3",
          "label": "2:3"
        }
      ],
      "default": "4/5"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Corner radius",
      "min": 0,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "Overlay"
    },
    {
      "type": "checkbox",
      "id": "overlay_content",
      "label": "Show overlay on hover",
      "info": "Shows Instagram icon overlay when hovering over the image",
      "default": false
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 50
    },
    {
      "type": "select",
      "id": "overlay_info",
      "label": "Overlay information",
      "options": [
        {
          "value": "none",
          "label": "Icon only"
        },
        {
          "value": "caption",
          "label": "Icon + Caption"
        },
        {
          "value": "likes",
          "label": "Icon + Likes/Comments"
        }
      ],
      "default": "none",
      "info": "Choose what information to display in the overlay"
    },
    {
      "type": "range",
      "id": "caption_max_lines",
      "label": "Caption max lines",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 3,
      "info": "Maximum number of lines to show for the caption"
    }
  ]
}
{% endschema %}