{% assign post = closest.metaobject['instagram-post'] %}
{% assign instagram_list = metaobjects['instagram-list']['instagram-feed-list'] %}

{% liquid
  assign onboarding = false
  assign instagram_username = 'instagram'

  if post == blank
    assign onboarding = true
  endif

  # Get username from the instagram-list metaobject
  if instagram_list.username != blank
    assign instagram_username = instagram_list.username
  endif

  # Get overlay settings from this block
  assign show_overlay = block.settings.overlay_content
  assign overlay_opacity = block.settings.overlay_opacity | divided_by: 100.0
%}

<div
  class="instagram-post-image instagram-post-image--{{ block.settings.image_ratio | replace: '/', '-' }} {% if show_overlay %}instagram-post-image--has-overlay{% endif %}"
  data-block-id="{{ block.id }}"
  style="
    border-radius: {{ block.settings.border_radius }}px;
    overflow: hidden;
    --overlay-opacity: {{ overlay_opacity }};
  "
  {{ block.shopify_attributes }}
>
  {% if onboarding %}
    {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
  {% else %}
    {% comment %} Get first image/video from images array {% endcomment %}
    {% for media in post.images.value limit: 1 %}
      {% if media.sources %}
        {{ media | video_tag: autoplay: true, loop: true, muted: true, class: 'instagram-post-image__video' }}
      {% else %}
        <img
          class="instagram-post-image__img"
          src="{{ media | image_url: width: 800, height: 1200, crop: 'center' }}"
          alt="{{ post.caption.value | escape | truncate: 100 }}"
          loading="lazy"
          width="800"
          height="1200"
        >
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if show_overlay %}
    <!-- Overlay link (shown on hover) -->
    <a
      href="https://instagram.com/{{ instagram_username }}"
      target="_blank"
      rel="noopener noreferrer"
      class="instagram-post-image__overlay-link"
      aria-label="View on Instagram"
    >
      <svg
        class="instagram-post-image__overlay-icon"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <path d="M12 2c2.717 0 3.056.01 4.122.06 1.065.05 1.79.217 2.428.465.66.254 1.216.598 1.772 1.153.509.5.902 1.105 1.153 1.772.247.637.415 1.363.465 2.428.047 1.066.06 1.405.06 4.122s-.01 3.056-.06 4.122c-.05 1.065-.218 1.79-.465 2.428a4.883 4.883 0 01-1.153 1.772c-.5.508-1.105.902-1.772 1.153-.637.247-1.363.415-2.428.465-1.066.047-1.405.06-4.122.06s-3.056-.01-4.122-.06c-1.065-.05-1.79-.218-2.428-.465a4.89 4.89 0 01-1.772-1.153 4.904 4.904 0 01-1.153-1.772c-.248-.637-.415-1.363-.465-2.428C2.013 15.056 2 14.717 2 12s.01-3.056.06-4.122c.05-1.066.217-1.79.465-2.428a4.88 4.88 0 011.153-1.772A4.897 4.897 0 015.45 2.525c.638-.248 1.362-.415 2.428-.465C8.944 2.013 9.283 2 12 2zm0 5a5 5 0 100 10 5 5 0 000-10zm6.5-.25a1.25 1.25 0 10-2.5 0 1.25 1.25 0 002.5 0zM12 9a3 3 0 110 6 3 3 0 010-6z"/>
      </svg>
    </a>
  {% endif %}
</div>

{% stylesheet %}
  .instagram-post-image {
    position: relative;
    width: 100%;
    overflow: hidden;
    background: var(--color-background, #000);
    --overlay-opacity: 0.5;
  }

  /* Overlay background - only show on images with overlay enabled */
  .instagram-post-image--has-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, var(--overlay-opacity));
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 1;
  }

  .instagram-post-image--has-overlay:hover::after {
    opacity: 1;
  }

  /* Overlay link - make whole overlay clickable */
  .instagram-post-image__overlay-link {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    text-decoration: none;
  }

  .instagram-post-image--has-overlay:hover .instagram-post-image__overlay-link {
    opacity: 1;
    pointer-events: auto;
  }

  .instagram-post-image__overlay-icon {
    width: 64px;
    height: 64px;
    fill: white;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
    transition: transform 0.2s ease;
    position: relative;
    z-index: 3;
  }

  .instagram-post-image__overlay-link:hover .instagram-post-image__overlay-icon {
    transform: scale(1.1);
  }

  .instagram-post-image--1-1,
  .instagram-post-image--4-5,
  .instagram-post-image--3-4,
  .instagram-post-image--2-3 {
    position: relative;
    width: 100%;
  }

  .instagram-post-image--1-1::before {
    content: '';
    display: block;
    padding-top: 100%; /* 1:1 */
  }

  .instagram-post-image--4-5::before {
    content: '';
    display: block;
    padding-top: 125%; /* 4:5 */
  }

  .instagram-post-image--3-4::before {
    content: '';
    display: block;
    padding-top: 133.33%; /* 3:4 */
  }

  .instagram-post-image--2-3::before {
    content: '';
    display: block;
    padding-top: 150%; /* 2:3 */
  }

  .instagram-post-image--1-1 .instagram-post-image__img,
  .instagram-post-image--1-1 .instagram-post-image__video,
  .instagram-post-image--4-5 .instagram-post-image__img,
  .instagram-post-image--4-5 .instagram-post-image__video,
  .instagram-post-image--3-4 .instagram-post-image__img,
  .instagram-post-image--3-4 .instagram-post-image__video,
  .instagram-post-image--2-3 .instagram-post-image__img,
  .instagram-post-image--2-3 .instagram-post-image__video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .instagram-post-image__img,
  .instagram-post-image__video {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  .instagram-post-image .placeholder-svg {
    width: 100%;
    height: auto;
    display: block;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Instagram Post Image",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "Displays image or video from parent Instagram post"
    },
    {
      "type": "header",
      "content": "Image Settings"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image aspect ratio",
      "options": [
        {
          "value": "adapt",
          "label": "Adapt to image"
        },
        {
          "value": "1/1",
          "label": "Square (1:1)"
        },
        {
          "value": "4/5",
          "label": "Portrait (4:5)"
        },
        {
          "value": "3/4",
          "label": "3:4"
        },
        {
          "value": "2/3",
          "label": "2:3"
        }
      ],
      "default": "4/5"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Corner radius",
      "min": 0,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "Overlay"
    },
    {
      "type": "checkbox",
      "id": "overlay_content",
      "label": "Show overlay on hover",
      "info": "Shows Instagram icon overlay when hovering over the image",
      "default": false
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 50
    }
  ]
}
{% endschema %}
